import{u as R,r as u,j as d,m as Z,a as e,F as te,L as i,v as O,C as L,a0 as $e,a1 as be,b as H,d as ie,i as Y,t as _,P as B,H as Te,N as Ve,a2 as ne,a3 as Ie,S as we,Q as re,A as Q,I as xe,g as se,a4 as Fe,l as fe,a5 as Ye,a6 as Oe,a7 as de,a8 as ve,a9 as ye,aa as He,K as me,ab as ge,ac as ce,w as F,x as Ae,ad as Pe,ae as je,X as ue,af as Me,q as pe,R as We,T as Be,ag as Se,s as Xe,ah as Ze,h as J,ai as qe,B as ze,D as Qe,aj as Ke,ak as Je,z as et,W as tt,al as at,f as st}from"./index-970d8b36.js";import{A as nt,g as rt}from"./audioRecorder-f401d27a.js";import{g as it,a as lt,b as ot,i as ct,M as le,A as Ne,c as dt,T as mt,d as ut,e as St,L as Ce,C as ht,f as Et}from"./Maps-5184eff3.js";const Ge=t=>{if(t)return/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(t)},De=t=>{if(t)return t==="<!CALL-NO-ANSWER!>"},ft=t=>{if(t)return/<!AUDIO-MESSAGE-IMAGE="(.*)"-AUDIO="(.*)"-DURATION="(.*)"!>/.test(t)},vt=t=>{if(t.length===0)return!0;if(t)return!/^<!.*!>$/.test(t)},gt=({onEnd:t,close:n})=>{const g=R(H),[A,C]=u.useState(!1),[N,o]=u.useState(0),[a,T]=u.useState(null),f=u.useRef(null);if(!g.EnableVoiceMessages)return null;u.useEffect(()=>{if(!A)return;let l=setInterval(()=>{o(E=>E+1)},1e3);return()=>clearInterval(l)},[A]),u.useEffect(()=>(f.current=new nt,()=>{f.current&&f.current.stop()}),[]);const I=l=>{let E=Math.floor(l/60),h=l%60;return`${E}:${h<10?"0":""}${h}`},s=async l=>{const E=await rt(new Blob(l),25,7,324,55,3);T(E)};return d(Z.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:0},transition:{duration:.2,ease:"easeInOut"},className:"audioMessage-container",children:[e("div",{className:"close",onClick:n}),d("div",{className:"audioMessage-wrapper",children:[d("div",{className:"duration",children:[A&&e("div",{className:"dot"}),I(N)]}),e("div",{className:"content",children:A?e(te,{children:a!=null&&a.base64?e("img",{src:a==null?void 0:a.base64}):i("APPS.MESSAGES.LOADING")}):i("APPS.MESSAGES.START_RECORDING")}),e("div",{className:"button","data-recording":A,onClick:()=>{var E;if(!((E=navigator.mediaDevices)!=null&&E.getUserMedia)||!(f!=null&&f.current))return O("error","No media devices found!");let l=f.current;A?l.stop().then(h=>{if(!h){o(0),C(c=>!c),L.PopUp.set({title:i("APPS.MESSAGES.EMPTY_RECORDING.TITLE"),description:i("APPS.MESSAGES.EMPTY_RECORDING.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.EMPTY_RECORDING.OK")}]});return}t(h),C(c=>!c)}):(l.start(100,s),C(h=>!h))},children:A?e($e,{}):e(be,{})})]})]})},At=({paymentAmount:t,setPaymentAmount:n,close:g})=>{const{User:A}=u.useContext(ae),C=R(H),[N]=A,[o,a]=u.useState(0),[T,f]=u.useState(4);let I={0:3,11:2.75,14:2.2};return u.useEffect(()=>{o===0&&f(I[0]);let s=0;for(let l=0;l<Object.keys(I).length;l++)o>=parseInt(Object.keys(I)[l])&&(s=I[Object.keys(I)[l]]);f(s)},[o]),u.useEffect(()=>{n(o)},[o]),d(Z.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:0},transition:{duration:.2,ease:"easeInOut"},className:"payment-container",children:[e("div",{className:"close",onClick:g}),d("div",{className:"payment-wrapper",children:[e("div",{className:"button",onClick:()=>t>0&&a(s=>s-1),children:"-"}),e("div",{className:"amount",children:e(ie,{type:"number",value:t,style:{fontSize:`${T}rem`},onChange:s=>{if(s.target.value.match(/^[0-9]+$/)&&parseFloat(s.target.value)>0&&parseFloat(s.target.value)<(C.MaxTransferAmount??Number.MAX_SAFE_INTEGER))a(parseFloat(s.target.value));else return s.preventDefault()}})}),e("div",{className:"button",onClick:()=>a(s=>s+1),children:"+"})]}),d("div",{className:"payment-buttons",children:[e("div",{className:"button",onClick:()=>Pt(t,N.number),children:i("APPS.MESSAGES.PAY.REQUEST")}),e("div",{className:"button",onClick:()=>ke(t,{id:N.id,name:N.name,number:N.number}),children:i("APPS.MESSAGES.PAY.SEND")})]})]})},ke=(t,n)=>{var g;if(H.value.EnableMessagePay&&!(!t&&t<=0)){if(t>(((g=H.value)==null?void 0:g.MaxTransferAmount)??Number.MAX_SAFE_INTEGER))return O("error","Amount is too high");L.PopUp.set({title:i("APPS.MESSAGES.PAY.SEND_TITLE").format({amount:H.value.CurrencyFormat.replace("%s",t.toString())}),description:i("APPS.MESSAGES.PAY.SEND_DESCRIPTION").format({amount:H.value.CurrencyFormat.replace("%s",t.toString()),name:n.name??Y(n.number)}),buttons:[{title:i("APPS.MESSAGES.PAY.SEND_BUTTON_CANCEL")},{title:i("APPS.MESSAGES.PAY.SEND_BUTTON_SEND"),cb:()=>{_("Wallet",{action:"sendPayment",number:n.number,amount:t},{success:!0}).then(A=>{var C,N;if(A.success){let o={id:n.id,sender:(N=(C=B)==null?void 0:C.PhoneNumber)==null?void 0:N.value,content:`<!SENT-PAYMENT-${t}!>`,attachments:[],timestamp:Date.now()};k.set([...k.value,o])}else{O("error","Failed to send payment "+JSON.stringify(A)),setTimeout(()=>{L.PopUp.set({title:i(`APPS.WALLET.${A.reason}.TITLE`),description:i(`APPS.WALLET.${A.reason}.DESCRIPTION`),buttons:[{title:i("APPS.WALLET.OK")}]})},500);return}})}}]})}},Pt=(t,n)=>{var A,C;if(!H.value.EnableMessagePay||!t&&t<=0)return;let g={sender:(C=(A=B)==null?void 0:A.PhoneNumber)==null?void 0:C.value,content:`<!REQUESTED-PAYMENT-${t}!>`,attachments:[],timestamp:Date.now()};_("Messages",{action:"sendMessage",number:n,content:g.content,attachments:[]},{messageId:Math.floor(Math.random()*1e3).toString()}).then(N=>{if(!N)return k.set([...k.value,{...g,delivered:!1}]);k.set([...k.value,{...g,id:N.messageId}])})},Ue={Messagelist:[{id:"1",number:"4802940940",name:"Loaf Scripts",unread:!0,lastMessage:"Sure Thing!",messages:[{sender:"4802940940",content:"Sure Thing!",timestamp:Date.now()-1e3*60*60*2},{sender:"1234567890",content:"Ready to release more products?",timestamp:Date.now()-1e3*60*60*2-1e3*60*5},{sender:"4802940940",content:"Hey!",timestamp:Date.now()-1e3*60*60*2-1e3*60*10}],timestamp:Date.now()-1e3*60*60*2},{id:"2",name:"Office Chat",unread:!0,lastMessage:"is the meeting at 8pm?",timestamp:Date.now()-1e3*60*60*4,isGroup:!0,members:[{number:"4802940940",name:"Loaf Scripts",isOwner:!1},{number:"1566444151",name:"Peter",isOwner:!1},{number:"2051440412",name:"Peter",isOwner:!1},{number:"2051440412",isOwner:!1}],messages:[{sender:"4802940940",content:"is the meeting at 8pm?",timestamp:Date.now()-1e3*60*60*4},{sender:"1566444151",content:"please confirm the time",timestamp:Date.now()-1e3*60*60*4-1e3*60*5},{sender:"2051440412",content:"Hey everyone, please make sure to be on time for the meeting",timestamp:Date.now()-1e3*60*60*4-1e3*60*10}]},{id:"3",number:"4802940963",unread:!1,lastMessage:"yeah i dont know whats going on, it was super weird. i think i might have to go to the doctor",timestamp:Date.now()-1e3*60*60*2*24,messages:[{sender:"4802940940",content:"yeah i dont know whats going on, it was super weird. i think i might have to go to the doctor",timestamp:Date.now()-1e3*60*60*2*24},{sender:"1234567890",content:"i hope you feel better soon",timestamp:Date.now()-1e3*60*60*2*24-1e3*60*5},{sender:"4802940940",content:"still sick :(",timestamp:Date.now()-1e3*60*60*2*24-1e3*60*10}]},{id:"4",number:"4802940942",unread:!0,lastMessage:"see you!",timestamp:Date.now()-1e3*60*60*2*24*2,messages:[{sender:"4802940942",content:"<!SENT-LOCATION-X=400.2Y=-1550.3!>",timestamp:Date.now()-1e3*60*60*2*24},{sender:"4802940942",content:`see you!

heres the location`,timestamp:Date.now()-1e3*60*60*2*24*2},{sender:"1234567890",content:"ofcourse, i will be there",timestamp:Date.now()-1e3*60*60*2*24*2-1e3*60*3},{sender:"4802940942",content:"hey buddy, still on for tomorrow?",timestamp:Date.now()-1e3*60*60*2*24*2-1e3*60*3}]}]};function Mt({location:t}){var l,E,h;const n=R(H),g=R(Ne),[A,C]=u.useState("losSantos"),N=it(n==null?void 0:n.CustomMaps),o=lt(n==null?void 0:n.CustomMaps),a=ot(A,n==null?void 0:n.CustomMaps),T={minZoom:0,maxZoom:6},I=o.mapTypes[A]||T,s=()=>A===le.LOS_SANTOS?Ce:A===le.CAYO_PERICO?ht:n!=null&&n.CustomMaps&&n.CustomMaps.length>0&&n.CustomMaps.findIndex((y,$)=>`customMap${$}`===A)!==-1?Et(A,n.CustomMaps):Ce;return u.useEffect(()=>{n!=null&&n.CustomMaps&&n.CustomMaps.length>0?C("customMap0"):C(ct({x:t[0],y:t[1]},n==null?void 0:n.CustomMaps)?le.LOS_SANTOS:le.CAYO_PERICO)},[t,n==null?void 0:n.CustomMaps]),u.useEffect(()=>{if(!(n!=null&&n.CustomMaps)||n.CustomMaps.length===0)return;const y=(()=>{var G;const $=n.CustomMaps.findIndex((V,U)=>`customMap${U}`===A);return $!==-1?((G=n.CustomMaps[$].styles)==null?void 0:G.map(U=>U.name))||["render","game","print"]:["render","game","print"]})();y.includes(g)||(Ne.set(y[0]),localStorage.setItem("lb-active-map-type",y[0]))},[A,n==null?void 0:n.CustomMaps,g]),u.useEffect(()=>{setTimeout(()=>{const c=document.querySelector(".leaflet-control-attribution.leaflet-control a");c&&(c.removeAttribute("href"),c.onclick=()=>{window.invokeNative("openUrl","https://leafletjs.com/")})},500)},[]),e("div",{className:"mapscomponent-wrapper",children:d(dt,{className:"map",crs:s(),style:{backgroundColor:((l=o.backgrounds)==null?void 0:l[g])||"#0d2b4f"},center:[t[0],t[1]],zoom:4,scrollWheelZoom:!1,zoomControl:!1,doubleClickZoom:!1,dragging:!1,bounceAtZoomLimits:!0,boxZoom:!1,maxBoundsViscosity:.95,maxBounds:a,attributionControl:!1,preferCanvas:!0,children:[e(mt,{url:((h=(E=N[A])==null?void 0:E.tileServer)==null?void 0:h.replace("{layer}",g))||"",minZoom:I.minZoom,maxZoom:I.maxZoom,maxNativeZoom:I.maxZoom,noWrap:!0},`${A}-${g}`),e(ut,{position:t,icon:St()})]})})}const k=me([]);function pt(){const{User:t,View:n,UnreadMessages:g}=u.useContext(ae),A=R(B.Settings),C=R(H),N=R(B.PhoneNumber),o=R(Q),[a,T]=t,[f,I]=n,[s,l]=g,E=R(k),h=R(L.Emoji),c=R(L.Gif),[y,$]=u.useState(!1),[G,V]=u.useState(null),[U,q]=u.useState(!1),[D,K]=u.useState(!1),[X,P]=u.useState(0),[b,m]=u.useState(null),v=u.useRef(null),w=u.useRef(0),p=u.useRef(!1),[M,j]=u.useState({content:"",attachments:[]});if(!a)return null;u.useEffect(()=>{var r;Te("Messages")&&_("Messages",{action:"getMessages",page:0,id:a==null?void 0:a.id},((r=Ue.Messagelist.find(S=>S.id===a.id))==null?void 0:r.messages)??[]).then(S=>{S&&S.length>0&&k.set([...S.reverse()])})},[o==null?void 0:o.active]);const he=()=>{if(M.content.length<=0&&M.attachments.length<=0&&!b)return O("info","Message is empty, returning");let r={sender:N,timestamp:Date.now(),id:a.id,content:M.content,attachments:M.attachments};if(!vt(M.content))return O("error","Message contains invalid characters, returning",M.content);if(b){if(p.current)return;p.current=!0,ge("Image",b.waves.message).then(S=>{ge("Audio",b.blob).then(x=>{r.content=`<!AUDIO-MESSAGE-IMAGE="${S}"-AUDIO="${x}"-DURATION="${b.duration}"!>`,_("Messages",{action:"sendMessage",number:a.number,content:r.content,id:a.id},{messageId:Math.random().toString(36).substring(7)}).then(W=>{W&&ce()?k.set([...k.value,{...r,id:W.messageId}]):k.set([...k.value,{...r,delivered:!1}]),p.current=!1,m(null)})}).catch(x=>{console.error("Failed to upload voice message audio",x),p.current=!1})}).catch(S=>{console.error("Failed to upload voice message image",S),p.current=!1});return}if(!ce())return k.set([...k.value,{...r,delivered:!1}]);_("Messages",{action:"sendMessage",number:a.number,content:M.content,attachments:M.attachments,id:a.id},{messageId:Math.random().toString(36).substring(7)}).then(S=>{S?(k.set([...k.value,{...r,id:S.messageId}]),m(null)):k.set([...k.value,{...r,delivered:!1}]),j({content:"",attachments:[]}),v.current&&(v.current.value=""),O("info","Updating recent message cache state"),F.APPS.MESSAGES.messages.set(F.APPS.MESSAGES.messages.value.map(x=>x.id===a.id?{...x,timestamp:new Date().getTime(),lastMessage:r.content.length>0&&r.content,unread:!1,deleted:!1}:x))})},Ee=()=>{L.PopUp.set({title:i("APPS.MESSAGES.SEND_LOCATION_POPUP.TITLE"),description:i("APPS.MESSAGES.SEND_LOCATION_POPUP.TEXT"),buttons:[{title:i("APPS.MESSAGES.SEND_LOCATION_POPUP.CANCEL")},{title:i("APPS.MESSAGES.SEND_LOCATION_POPUP.SEND"),cb:()=>{_("Maps",{action:"getCurrentLocation"},{x:0,y:0}).then(r=>{if(!r)return;let S={id:a.id,sender:N,content:`<!SENT-LOCATION-X=${Ae(r.x,2)}Y=${Ae(r.y,2)}!>`,attachments:[],timestamp:Date.now()};_("Messages",{action:"sendMessage",number:a.number,content:S.content,attachments:S.attachments,id:S.id},{messageId:Math.random().toString(36).substring(7)}).then(x=>{if(!x)return k.set([...k.value,{...S,delivered:!1}]);k.set([...k.value,{...S,id:x.messageId}])})})}}]})},{handleScroll:Re}=Ve({fetchData:r=>_("Messages",{action:"getMessages",id:a.id,page:r}),onDataFetched:r=>{let S=document.querySelector(".message-container");w.current=S.scrollHeight,k.set([...r.reverse(),...k.value])},isReversed:!0,perPage:25});u.useEffect(()=>{let r=document.querySelector(".message-container");const S=r.scrollHeight;r.scrollTop+=S-w.current,r.scroll},[E]),ne("messages:newMessage",r=>{a.id===r.channelId&&k.set([...k.value,{...r,timestamp:Date.now()}])},{waitUntilService:!0}),ne("messages:renameGroup",r=>{a.id===r.channelId&&T(S=>({...S,name:r.name}))},{waitUntilService:!0}),ne("messages:messageDeleted",r=>{if(O("info","messages:messageDeleted triggered",r),!r)return O("error","Did not get any data from messages:messageDeleted, returning");k.set(k.value.filter(S=>S.id!==r.messageId))},{waitUntilService:!0}),ne("messages:removeMember",r=>{a.id===r.channelId&&r.number===N&&(I("userlist"),T(null))},{waitUntilService:!0});const Le=Ie(r=>{if(!C.DeleteMessages)return O("error","Config.DeleteMessages is set to false");let S=r.target;for(;!S.classList.contains("message");)S=S.parentElement;let x=S.getAttribute("data-id");if(!x)return O("error","Failed to get message id when longpressing");isNaN(x)||(x=parseInt(x));let W=E.find(oe=>oe.id===x);if(!W)return O("error","Failed to find message with id",x);W.sender===N&&(Ge(W.content)||_e(W.content)||De(W.content)||L.ContextMenu.set({buttons:[{title:i("APPS.MESSAGES.DELETE"),color:"red",cb:()=>{_("Messages",{action:"deleteMessage",channel:a.id,id:x}).then(oe=>{if(!oe)return O("error","Failed to delete message")})}}]}))}),_e=r=>!r||!C.EnableMessagePay?!1:/<!SENT-PAYMENT-(\d*)!>/.test(r)?!0:!!/<!REQUESTED-PAYMENT-(\d*)!>/.test(r);return e(te,{children:d(Z.div,{...we("right","message",.2),className:"animation-container",children:[d(re,{children:[y&&e(Tt,{setShow:$,setShowUserInfo:V,sendLocation:Ee,setData:T,data:a}),G&&e(bt,{setShow:V,user:a!=null&&a.isGroup?G:a})]}),d("div",{className:"message-header",children:[d("div",{className:"back",onClick:()=>{var r;I("userlist"),T(null),(r=Q.value.active)!=null&&r.data&&Q.patch({active:{name:"Messages",data:null}}),a.unread&&(_("Messages",{action:"markRead",id:a.id}),l(S=>S-1))},children:[e(xe,{}),s>0&&e("span",{className:"back-title",children:s})]}),d("div",{className:"user",onClick:()=>{a!=null&&a.isGroup?$(!0):V(!0)},children:[a!=null&&a.isGroup?e("div",{className:"group-avatar",style:{backgroundImage:a!=null&&a.avatar?`url(${a.avatar})`:null},children:!(a!=null&&a.avatar)&&d(te,{children:[a.members.sort((r,S)=>r.name&&S.name?r.name.localeCompare(S.name):r.name?-1:S.name?1:0).sort((r,S)=>(r.avatar?1:-1)-(S.avatar?1:-1)).slice(0,5).map((r,S)=>e("div",{className:"avatar","data-hasavatar":(r==null?void 0:r.avatar)!==void 0,style:{backgroundImage:r!=null&&r.avatar?`url(${r.avatar})`:null,zIndex:a.members.length-S},children:r.name?!(r!=null&&r.avatar)&&se(r.name):e("img",{src:`./assets/img/avatar-placeholder-${A.display.theme}.svg`,alt:""})},S)),a.members.length===0&&e("img",{src:`./assets/img/avatar-placeholder-${A.display.theme}.svg`,alt:""})]})}):e("div",{className:"avatar","data-hasavatar":(a==null?void 0:a.avatar)!==void 0,style:{backgroundImage:a!=null&&a.avatar?`url(${a.avatar})`:null},children:a.name?!(a!=null&&a.avatar)&&se(a.name):e("img",{src:`./assets/img/avatar-placeholder-${A.display.theme}.svg`,alt:""})}),e("div",{className:"name",children:a!=null&&a.isGroup?a.name??`${a.members.length===0?1:a.members.length} ${i("APPS.MESSAGES.PEOPLE")}`:a.name??Y(a.number)})]}),d("div",{className:"buttons","data-hidden":a==null?void 0:a.isGroup,children:[e(Fe,{onClick:()=>{a!=null&&a.isGroup||fe({number:a.number})}}),e(Ye,{onClick:()=>{a!=null&&a.isGroup||fe({number:a.number,videoCall:!0})}})]})]}),e("div",{className:"message-container",onScroll:Re,style:D||U?{height:"48%"}:{},children:e("div",{className:"message-body",children:E.map((r,S)=>e(Nt,{index:S,messages:E,message:r,longPressEvent:Le},S))})}),e("div",{className:"attachments",children:M.attachments.map((r,S)=>d("div",{className:"attachment",children:[Oe(r)?e("video",{src:r,muted:!0,controls:!1,loop:!0,autoPlay:!0}):e(de,{src:r,blur:!0}),e(ve,{onClick:()=>{j({...M,attachments:M.attachments.filter((x,W)=>W!==S)})}})]},S))}),d("div",{className:"message-bottom","data-expanded":!!(D||U),children:[e("div",{className:"upper",children:d("div",{className:"input","data-border":!b,children:[b?d("div",{className:"audio-message",children:[e(ve,{onClick:()=>m(null)}),e("div",{className:"audio-waves",children:e("img",{src:b.waves.placeholder})})]}):e(ie,{placeholder:i("APPS.MESSAGES.PLACEHOLDER"),ref:v,value:M.content,onChange:r=>{j({content:r.target.value,attachments:M.attachments})},onKeyDown:r=>{r.key=="Enter"&&he()}}),(M.content.length>0||M.attachments.length>0||b)&&e("div",{className:"send",onClick:he,children:e(ye,{})})]})}),!D&&!U&&e("div",{className:"actions-wrapper",children:d("div",{className:"actions",children:[e("div",{className:"action",onClick:()=>{if(h)return L.Emoji.reset();L.Emoji.set({onSelect:r=>j(S=>({content:`${S.content}${r.emoji}`,attachments:S.attachments}))})},children:"ðŸ˜€"}),e("div",{className:"action",onClick:()=>{var r,S,x;M.attachments.length<3&&L.Gallery.set({includeVideos:!0,allowExternal:(x=(S=(r=H)==null?void 0:r.value)==null?void 0:S.AllowExternal)==null?void 0:x.Messages,onSelect:W=>j({...M,attachments:[...M.attachments,W.src]})})},children:e("img",{src:"./assets/img/icons/messages/gallery.png"})}),C.EnableGIFs!==!1&&e("div",{className:"action small",onClick:()=>{if(c)return L.Gif.reset();L.Gif.set({onSelect:r=>j(S=>({content:S.content,attachments:[...S.attachments??[],r]}))})},children:"GIF"}),(C==null?void 0:C.EnableMessagePay)&&!(a!=null&&a.isGroup)&&e("div",{className:"action ",onClick:()=>{q(!1),K(r=>!r)},children:"$"}),e("div",{className:"action",onClick:()=>Ee(),children:e(He,{})}),(C==null?void 0:C.EnableVoiceMessages)&&e("div",{className:"action",onClick:()=>{K(!1),q(r=>!r)},children:e(be,{})})]})}),e(re,{children:D&&e(At,{paymentAmount:X,setPaymentAmount:P,close:()=>K(!1)})}),e(re,{children:U&&e(gt,{onEnd:r=>{if(!r)return O("error","Failed to get audio message data");m({blob:r.blob,waves:r.waveform,duration:r.duration}),q(!1)},close:()=>q(!1)})})]})]})})}const Nt=({messages:t,message:n,index:g,longPressEvent:A})=>{var y,$;const{User:C}=u.useContext(ae),N=R(B.PhoneNumber),[o]=C,a=R(H);let T,f,I,s,l,E,h=n.sender===N?"self":"other",c=((y=t[g+1])==null?void 0:y.sender)===N?"self":"other";if(t[g+1]?I=Math.abs(n.timestamp-t[g+1].timestamp)/36e5:c=void 0,o!=null&&o.isGroup)T=($=o.members.find(G=>G.number===n.sender))==null?void 0:$.name,f=!t[g-1]||t[g-1].sender!==n.sender;else if(T=o.name,n.content)if(De(n.content))if(h==="other")n.content=i("APPS.MESSAGES.MISSED_CALL").format({number:n.sender});else return null;else/<!SENT-PAYMENT-(\d*)!>/.test(n.content)?s={amount:n.content.match(/\d/g).join(""),request:!1}:/<!REQUESTED-PAYMENT-(\d*)!>/.test(n.content)&&(s={amount:n.content.match(/\d/g).join(""),request:!0});if(Ge(n.content)){let G=n.content.match(/X=(-?\d*\.?\d*)Y/)[1],V=n.content.match(/Y=(-?\d*\.?\d*)!>/)[1];l={x:G,y:V}}return ft(n.content)&&(E={wave:n.content.match(/AUDIO-MESSAGE-IMAGE="([^"]+)"/)[1],src:n.content.match(/AUDIO="([^"]+)"/)[1],duration:n.content.match(/DURATION="([^"]+)"/)[1]}),d("div",{className:`message ${h}`,"data-id":n.id,...A,children:[f&&h=="other"&&e("div",{className:"user",children:T??Y(n.sender)}),n.delivered===!1?d("div",{className:"content-wrapper",children:[s&&e("div",{className:"payment",children:a.CurrencyFormat.replace("%s",s.amount)}),!s&&e("div",{className:"content",children:Pe(n.content)}),e(je,{})]}):s||l||E?d(te,{children:[l&&d("div",{className:"location",onClick:()=>{L.ContextMenu.set({buttons:[{title:i("APPS.MESSAGES.OPEN_IN_MAPS"),cb:()=>{Q.patch({active:{name:"Maps",data:{location:[l.y,l.x],name:i("APPS.MESSAGES.USERS_LOCATION").format({name:T??Y(n.sender)}),icon:o.avatar}}})}},{title:i("APPS.MAPS.SET_WAYPOINT"),cb:()=>{_("Maps",{action:"setWaypoint",data:{x:l.x,y:l.y}})}}]})},children:[e(Mt,{location:[parseFloat(l.y),parseFloat(l.x)]}),h==="other"&&d("div",{className:"sender",children:[T??Y(n.sender)," ",i("APPS.MESSAGES.SENT_LOCATION")]})]}),s&&e("div",{className:"payment",children:s.request?d("div",{className:ue("request",h),children:[d("div",{className:"title",children:[a.CurrencyFormat.replace("%s",Me(s.amount).toString())," ",i("APPS.MESSAGES.PAY.REQUESTED")]}),h==="other"&&e("div",{className:"button",onClick:()=>ke(s.amount,{id:o.id,number:o.number,name:o.name}),children:i("APPS.MESSAGES.PAY.PAY")})]}):e("div",{className:"sent",children:a.CurrencyFormat.replace("%s",Me(s.amount).toString())})}),E&&e(Ct,{data:E,sender:h})]}):n.content&&e("div",{className:"content",children:Pe(n.content)}),n.attachments&&n.attachments.length>0&&e("div",{className:"attatchments",children:n.attachments.map((G,V)=>Oe(G)?e("video",{src:G,controls:!1,loop:!0,autoPlay:!0,muted:!0,onClick:U=>L.FullscreenImage.set(G)},V):e(de,{src:G,blur:!0,onClick:()=>L.FullscreenImage.set(G)},V))}),n.delivered===!1?e("div",{className:"status",children:i("APPS.MESSAGES.NOT_DELIVERED")}):t[g+1]&&I>6?e("div",{className:"date",children:pe(n.timestamp)}):h!==c&&e("div",{className:"date",children:pe(n.timestamp)})]},g)},Ct=({data:t,sender:n})=>{var T;const[g,A]=u.useState(!1),[C,N]=u.useState(0),o=u.useRef(null);u.useEffect(()=>{o.current&&(o.current.onended=()=>A(!1))},[o]);const a=f=>{f=Math.floor(f);const I=Math.floor(f/60),s=f-I*60;return`${I<10?"0"+I:I}:${s<10?"0"+s:s}`};return d("div",{className:`voice-message ${n}`,children:[e("a",{onClick:()=>{o.current&&(g?(o.current.pause(),o.current.currentTime=0):o.current.play().catch(()=>O("error","Failed to play audio message")),A(f=>!f))},children:g?e(We,{}):e(Be,{})}),d("div",{className:"wave",children:[e("div",{className:"overlay",style:{width:`${(t.duration-C)/t.duration*100}%`}}),e("img",{src:t.wave,alt:"wave"})]}),e("div",{className:"duration",children:a(g&&Math.floor(((T=o.current)==null?void 0:T.currentTime)+.5)!==0?o.current.currentTime:t.duration)}),e("audio",{ref:o,onTimeUpdate:f=>N(f.currentTarget.currentTime),children:e("source",{src:t.src,type:"audio/mpeg"})})]})},bt=({user:t,setShow:n})=>{const g=R(B.Settings);return d(Z.div,{...Se,className:"info-panel",children:[e("div",{className:"info-panel-header",children:e("div",{className:"done",onClick:()=>n(!1),children:i("APPS.MESSAGES.DONE")})}),d("div",{className:"info-panel-body",children:[d("div",{className:"info-panel-top",children:[e("div",{className:"avatar","data-hasavatar":(t==null?void 0:t.avatar)!==void 0,style:{backgroundImage:t!=null&&t.avatar?`url(${t.avatar})`:null},children:t.name?!(t!=null&&t.avatar)&&se(t.name):e("img",{src:`./assets/img/avatar-placeholder-${g.display.theme}.svg`,alt:""})}),e("div",{className:"name",children:t.name??Y(t.number)})]}),e("div",{className:"items",children:!t.company&&d(te,{children:[t.name&&e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>Xe(t.number),children:Y(t.number)})}),e("div",{className:"info-section",children:t.name?e("div",{className:"item blue",onClick:()=>{L.Share.set({type:"contact",data:{firstname:t.firstname,lastname:t.lastname,number:t.number,avatar:t.avatar}})},children:i("APPS.PHONE.CONTACTS.SHARE_CONTACT")}):e("div",{className:"item blue",onClick:()=>{Q.patch({active:{name:"Phone",data:{view:"newContact",number:t.number}}})},children:i("APPS.PHONE.CONTACTS.ADD_CONTACT")})})]})})]})]})},Tt=t=>{const{View:n}=u.useContext(ae),g=R(B.Settings),[A,C]=n,[N,o]=u.useState(t.data.name),[a,T]=u.useState(t.data.avatar);let f=t.data,I=!f.members.find(s=>s.isOwner);return e(te,{children:d(Z.div,{...Se,className:"info-panel",children:[d("div",{className:"info-panel-header",children:[e("div",{}),e("div",{className:"close",children:e("div",{className:"button",onClick:()=>t.setShow(!1)})}),e("div",{className:"done",onClick:()=>{N&&N!==""&&N!==f.name?_("Messages",{action:"renameGroup",id:f.id,name:N}).then(s=>{t.setShow(!1)}):t.setShow(!1)},children:i("APPS.MESSAGES.DONE")})]}),d("div",{className:"info-panel-body",children:[d("div",{className:"info-panel-top",children:[a?e(de,{className:"group-image",src:a,blur:!0}):d("div",{className:"group-avatar",children:[f.members.sort((s,l)=>s.avatar?1:-1).slice(0,5).map((s,l)=>e("div",{className:"avatar","data-hasavatar":(s==null?void 0:s.avatar)!==void 0,style:{backgroundImage:s!=null&&s.avatar?`url(${s.avatar})`:null,zIndex:f.members.length-l},children:s.name?!(s!=null&&s.avatar)&&se(s.name):e("img",{src:`./assets/img/avatar-placeholder-${g.display.theme}.svg`,alt:""})},l)),f.members.length===0&&e("img",{src:`./assets/img/avatar-placeholder-${g.display.theme}.svg`,alt:""})]}),e("div",{className:"add-photo",onClick:()=>{var s,l,E;a?L.PopUp.set({title:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.TITLE"),description:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.CANCEL")},{title:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.REMOVE"),color:"red",cb:()=>{_("Messages",{action:"removeGroupAvatar",id:f.id},!0).then(h=>{if(!h)return O("warning","Could not remove group avatar");t.setData(c=>{let y=c;return y.avatar=null,y}),T(null)})}}]}):L.Gallery.set({allowExternal:(E=(l=(s=H)==null?void 0:s.value)==null?void 0:l.AllowExternal)==null?void 0:E.Messages,onSelect:h=>_("Messages",{action:"setGroupAvatar",id:f.id,avatar:h.src},!0).then(c=>{if(!c)return O("warning","Could not set group avatar");t.setData(y=>{let $=y;return $.avatar=h.src,$}),T(h.src)})})},children:a?"Remove Photo":" Add Photo"})]}),d("div",{className:"items",children:[e("div",{className:"info-section",children:d("div",{className:"item blue",children:[e(Ze,{className:"add"}),e(ie,{defaultValue:f.name??i("APPS.MESSAGES.GROUP_NAME"),onChange:s=>o(s.target.value)})]})}),d("div",{className:"subtitle",children:[f.members.length===0?1:f.members.length," ",i("APPS.MESSAGES.MEMBERS")]}),d("div",{className:"info-section",children:[d("div",{className:"item",onClick:()=>L.ContactSelector.set({filter:f.members.map(s=>s.number),onSelect:s=>{if(f.members.find(l=>l.number===s.number))return O("info","User is already in group");_("Messages",{action:"addMember",id:f.id,number:s.number},!0).then(l=>{if(!l)return O("warning","Could not add member to group");t.setData(E=>{let h=E;return h.members.push({...s,name:J(s.firstname,s.lastname),isOwner:!1}),h})})}}),children:[e(qe,{className:"add"}),e("div",{className:"name",children:i("APPS.MESSAGES.ADD_MEMBER")})]}),f.members.sort((s,l)=>s.name&&!l.name?-1:!s.name&&l.name?1:s.name<l.name?-1:s.name>l.name?1:0).map((s,l)=>d("div",{className:"item",children:[I&&e(ze,{className:"remove",onClick:()=>{L.PopUp.set({title:i("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:i("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({name:s.name??Y(s.number)}),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{_("Messages",{action:"removeMember",number:s.number,id:f.id}).then(E=>{E&&(t.setData(h=>{let c=h;return c.members=c.members.filter(y=>y.number!==s.number),c}),t.setShow(!1))})}}]})}}),e("div",{className:"avatar","data-hasavatar":(s==null?void 0:s.avatar)!==void 0,style:{backgroundImage:s!=null&&s.avatar?`url(${s.avatar})`:null},children:s.name?!(s!=null&&s.avatar)&&se(s.name):e("img",{src:`./assets/img/avatar-placeholder-${g.display.theme}.svg`,alt:""})}),d("div",{className:"details",children:[e("div",{className:"name",children:s.name??Y(s.number)}),s.name&&e("div",{className:"phone-number",children:Y(s.number)})]}),e(Qe,{className:"info",onClick:()=>t.setShowUserInfo({...s})})]},l))]}),e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>t.sendLocation(),children:i("APPS.MESSAGES.SHARE_LOCATION")})}),e("div",{className:"info-section",onClick:()=>{L.PopUp.set({title:i("APPS.MESSAGES.LEAVE_POPUP.TITLE"),description:i("APPS.MESSAGES.LEAVE_POPUP.TEXT"),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.LEAVE_POPUP.LEAVE"),color:"red",cb:()=>{_("Messages",{action:"leaveGroup",id:f.id}).then(s=>{if(!s)return O("info","Failed to leave group, server didnt callback request");C("userlist"),t.setShow(!1)})}}]})},children:d("div",{className:"item red",children:[e(Ke,{}),i("APPS.MESSAGES.LEAVE_GROUP")]})})]})]})]})})};function It(){const{User:t,View:n,Newmessage:g,ImportedUser:A}=u.useContext(ae),[C,N]=t,[o,a]=n,[T,f]=A,I=R(B.Settings),s=R(B.PhoneNumber),[l,E]=g,h=R(F.APPS.PHONE.contacts),[c,y]=u.useState([]),$=u.useRef(null),[G,V]=u.useState(""),[U,q]=u.useState([]),[D,K]=u.useState({content:"",attachments:[]});u.useEffect(()=>{T&&(y([T]),f(null))},[T]);const X=()=>{(D.content.length>0||D.attachments.length>0)&&(c.length>1?_("Messages",{action:"createGroup",members:c,content:D.content,attachments:D.attachments}).then(P=>{if(!P)return O("error","Failed to create group");N({id:P.channelId,lastMessage:D.content,timestamp:Date.now(),isGroup:!0,members:c.map(b=>{let m=J(b.firstname,b.lastname);return{...b,name:m}})}),a("messages"),E(!1)}):(_("Messages",{action:"sendMessage",number:c[0].number,content:D.content,attachments:D.attachments}).then(P=>{var v,w,p,M;if(!P)return O("error","Failed to send message");let b;c[0].name?b=c[0].name:(v=c[0])!=null&&v.firstname&&(b=J((w=c[0])==null?void 0:w.firstname,(p=c[0])==null?void 0:p.lastname));let m={number:c[0].number,name:b,avatar:(M=c[0])==null?void 0:M.avatar};N({...m,id:P.channelId,lastMessage:D.content,timestamp:Date.now()}),O("info","Updating recent message cache state"),F.APPS.MESSAGES.messages.set(F.APPS.MESSAGES.messages.value.map(j=>j.id===P.channelId?{...j,timestamp:new Date().getTime(),lastMessage:D.content,unread:!1,deleted:!1}:j))}),a("messages"),E(!1)))};return u.useEffect(()=>{if(G.length>0){if(!h)return O("error","Contacts not loaded");q(h.filter(P=>{let b=J(P.firstname,P.lastname);return b&&(b==null?void 0:b.toLowerCase().includes(G==null?void 0:G.toLowerCase()))&&!P.company}))}else q([])},[G]),d(Z.div,{...Se,className:"new-message-container",children:[d("div",{className:"new-message-header",children:[e("span",{}),e("div",{className:"title",children:i("APPS.MESSAGES.NEW_MESSAGE")}),e("div",{className:"button",onClick:()=>{var b,m,v;c.length>0&&(D.content.length>0||D.attachments.length>0)?X():(E(!1),(v=(m=(b=Q)==null?void 0:b.value)==null?void 0:m.active)!=null&&v.data&&Q.patch({active:{...Q.value.active,data:null}}))},children:c.length>0&&(D.content.length>0||D.attachments.length>0)?i("APPS.MESSAGES.SEND"):i("APPS.MESSAGES.CANCEL")})]}),d("div",{className:"new-message-body",children:[d("div",{className:"new-message-search",children:[d("div",{className:"to",children:[i("APPS.MESSAGES.TO"),":"]}),e("div",{className:"contacts",children:c.map((P,b)=>{let m=J(P.firstname,P.lastname),v=m!=="Unknown";return e("div",{className:ue("contact",v?"green":"blue"),onClick:()=>{L.PopUp.set({title:i("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:i("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({NAME:m??Y(P.number)}),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{let w=c.filter(p=>p.number!==P.number);y(w)}}]})},children:v?m:Y(P.number)},b)})}),e(ie,{type:"text",ref:$,onChange:P=>{if(V(P.target.value),P.target.value.length==s.length&&/^\d+$/g.test(P.target.value)){if(P.target.value===s||c.find(m=>m.number==P.target.value))return;y([...c,{number:P.target.value}]),$.current.value="",V("")}},onKeyDown:P=>{var b;P.key=="Backspace"&&G.length==0?((b=c[c.length-1])==null?void 0:b.name)===void 0?($.current.value=c[c.length-1].number,y(c.slice(0,c.length-1))):y(c.slice(0,-1)):P.key=="Tab"&&(P.preventDefault(),U.length==1&&(y([...c,U[0]]),$.current.value="",V("")))}})]}),e("div",{className:"search-results",children:U&&U.filter(P=>!c.find(b=>b.number==P.number)).map((P,b)=>{let m=J(P.firstname,P.lastname);return d("div",{className:"contact",onClick:()=>{c.find(w=>w.number==P.number)||(y([...c,P]),$.current.value="",V(""))},children:[e("img",{src:P.avatar??`./assets/img/avatar-placeholder-${I.display.theme}.svg`}),d("div",{className:"user",children:[e("div",{className:"name",children:m}),e("div",{className:"number",children:Y(P.number)})]})]},b)})})]}),c.length>0&&U.length===0&&e("div",{className:"message-bottom absolute",children:e("div",{className:"upper",children:d("div",{className:"input",children:[e(ie,{placeholder:i("APPS.MESSAGES.PLACEHOLDER"),value:D.content,onChange:P=>{K({content:P.target.value??"",attachments:D.attachments})},onKeyDown:P=>{P.key=="Enter"&&X()}}),(D.content.length>0||D.attachments.length>0)&&e("div",{className:"send",onClick:()=>X(),children:e(ye,{})})]})})})]})}const z=me([]),ee=me([]);function wt(){var b;const{User:t,View:n,Newmessage:g,UnreadMessages:A,ImportedUser:C}=u.useContext(ae),N=R(B.PhoneNumber),o=(b=R(Q))==null?void 0:b.active,[a,T]=t,[f,I]=n,[s,l]=C,[E,h]=g,[c,y]=A,$=R(F.APPS.PHONE.contacts),G=R(F.APPS.MESSAGES.messages),V=R(z),[U,q]=u.useState(""),[D,K]=u.useState(!1),X=R(ee);u.useEffect(()=>{if(Te("Messages"))if(G)O("info","Using cache for recent messages"),y(V.filter(m=>m.unread).length),z.set(G.map(m=>{if(!m.name){let v=$.find(w=>w.number===m.number);if(!v)return m;m.name=J(v.firstname,v.lastname),m.avatar=v==null?void 0:v.avatar}return m})??[]);else{if(!ce())return O("info","No service, not fetching recent messages");_("Messages",{action:"getRecentMessages"},Ue.Messagelist).then(m=>{if(!m)return O("error","No recent messages");let v=m.map(w=>{if(w.isGroup)return w.members=w.members.filter(p=>p.number!==N).map(p=>{let M=$.find(j=>j.number===p.number);return{name:M&&M.firstname?J(M==null?void 0:M.firstname,M==null?void 0:M.lastname):void 0,avatar:M==null?void 0:M.avatar,blocked:M==null?void 0:M.blocked,favourite:M==null?void 0:M.favourite,number:p.number,isOwner:p.isOwner}}),w;{let p=$.find(M=>M.number===w.number);return w.name=p!=null&&p.lastname?`${p.firstname} ${p.lastname}`:p==null?void 0:p.firstname,w.avatar=p==null?void 0:p.avatar,w}});y(v.filter(w=>w.unread).length),z.set(v),O("info","setting cache"),F.APPS.MESSAGES.messages.set(v)})}},[G,o]);let P=u.useRef(!1);return u.useEffect(()=>{var m;if(!P.current&&o!=null&&o.data&&(P.current=!0,o!=null&&o.data&&((m=o.data)==null?void 0:m.view)=="messages")){let v=V==null?void 0:V.find(w=>w.number===o.data.number);v?(T(v),I("messages")):(h(!0),l({number:o.data.number,name:o.data.name,avatar:o.data.avatar}))}},[o==null?void 0:o.data,V]),ne("messages:newMessage",m=>{let v=JSON.parse(JSON.stringify(z.value)),w=v.findIndex(p=>p.id===m.channelId);if(w!==-1&&v.unshift(v.splice(w,1)[0]),v.length===0)return O("error","No recent messages");v[0].lastMessage=m.content,v[0].timestamp=new Date,z.set(v)},{waitUntilService:!0}),d(te,{children:[e(re,{children:E&&e(It,{})}),d(Z.div,{...we("left","messagelist",.2),className:"animation-container",children:[d("div",{className:"messages-header",children:[d("div",{className:"buttons",children:[e("div",{className:"edit",onClick:()=>K(!D),children:D?i("APPS.MESSAGES.DONE"):i("APPS.MESSAGES.EDIT")}),e(Je,{"data-disabled":D,onClick:()=>h(!0)})]}),e("div",{className:"title",children:i("APPS.MESSAGES.TITLE")})]}),e(et,{placeholder:i("SEARCH"),onChange:m=>q(m.target.value)}),e("div",{className:"users-list",children:V.filter(m=>{var v,w;return m.deleted?!1:(m.isGroup?m.members.find(p=>{var M;return p&&(((M=p.name)==null?void 0:M.toLowerCase().includes(U==null?void 0:U.toLowerCase()))||p.number.includes(U))}):((v=m.name)==null?void 0:v.toLowerCase().includes(U==null?void 0:U.toLowerCase()))||m.number.includes(U))||((w=m==null?void 0:m.lastMessage)==null?void 0:w.toLowerCase().includes(U==null?void 0:U.toLowerCase()))}).sort((m,v)=>v.timestamp-m.timestamp).map((m,v)=>e(Ot,{user:m,editMode:D,onClick:()=>{if(T(m),I("messages"),m.unread){_("Messages",{action:"markRead",id:m.id},!0),y(p=>p-1);let w=F.APPS.MESSAGES.messages.value;F.APPS.MESSAGES.messages.set(w.map(p=>(p.id===m.id&&(p.unread=!1),p)))}}},v))}),e(re,{children:D&&d(Z.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},exit:{opacity:0,y:50},transition:{duration:.2,ease:"easeInOut"},className:"messages-footer",children:[e("div",{className:"button","data-disabled":!0,children:i("APPS.MESSAGES.READ")}),e("div",{className:"button",onClick:()=>{if(X.length===0)return O("info","No messages selected, can't delete");L.PopUp.set({title:i("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),description:i("APPS.MESSAGES.DELETE_CONVERSATION.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.DELETE"),cb:()=>{_("Messages",{action:"deleteConversations",channels:X},!0).then(m=>{if(!m)return O("error","Failed to delete conversations");K(!1),z.set(V.filter(v=>!X.includes(v.id))),F.APPS.MESSAGES.messages.set([...F.APPS.MESSAGES.messages.value.map(v=>(X.includes(v.id)&&(v.deleted=!0),v))]),ee.set([])})}}]})},children:i("APPS.MESSAGES.DELETE")})]})})]})]})}const Ot=({user:t,editMode:n,onClick:g})=>{var I,s;const A=R(H),C=R(B.Settings),N=R(z),[o,a]=u.useState(!1);let T;const f=Ie(l=>{L.ContextMenu.set({buttons:[{title:i("APPS.MESSAGES.MARK_AS_READ"),cb:()=>{_("Messages",{action:"markRead",id:t.id},!0).then(E=>{if(!E)return O("error","Failed to mark message as read");z.set(N.map(c=>(c.id===t.id&&(c.unread=!1),c)));let h=F.APPS.MESSAGES.messages.value;F.APPS.MESSAGES.messages.set(h.map(c=>(c.id===t.id&&(c.unread=!1),c)))})}},{title:i("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),color:"red",cb:()=>{L.PopUp.set({title:i("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),description:i("APPS.MESSAGES.DELETE_CONVERSATION.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.DELETE"),cb:()=>{_("Messages",{action:"deleteConversations",channels:[t.id]},!0).then(E=>{if(!E)return O("error","Failed to delete conversations");z.set(N.filter(h=>h.id!==t.id)),F.APPS.MESSAGES.messages.set([...F.APPS.MESSAGES.messages.value.map(h=>(h.id===t.id&&(h.deleted=!0),h))]),ee.set([])})}}]})}}]})});if(t.isGroup)if(t.name)T=t.name;else if(t.members.length===0)T=i("APPS.MESSAGES.GROUP");else{let l=t.members.length-1;T=t.members.sort((E,h)=>E.name&&!h.name?-1:!E.name&&h.name?1:E.name<h.name?-1:E.name>h.name?1:0).slice(0,2).map((E,h)=>{var y;let c=E.name?E.name:Y(E.number);return h===1&&l>2?`${c} +${l} ${(y=i("APPS.MESSAGES.OTHER"))==null?void 0:y.toLowerCase()}`:c}).join(", ")}else T=t.name;if(t.lastMessage){if(t.lastMessage==="Attachment"&&(t.lastMessage=i("APPS.MESSAGES.SENT_A_PHOTO")),/<!SENT-PAYMENT-(\d*)!>/.test(t.lastMessage)){let l=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${i("APPS.MESSAGES.SENT")} ${A.CurrencyFormat.replace("%s",l)}`}else if(/<!REQUESTED-PAYMENT-(\d*)!>/.test(t.lastMessage)){let l=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${i("APPS.MESSAGES.REQUESTED")} $${l}`}else if(/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(t.lastMessage))t.lastMessage=`${i("APPS.MESSAGES.SENT_LOCATION_SHORT")}`;else if(t.lastMessage.startsWith('<!AUDIO-MESSAGE-IMAGE="'))t.lastMessage=i("APPS.MESSAGES.SENT_AUDIO_MESSAGE");else if(t.lastMessage==="<!CALL-NO-ANSWER!>")t.lastMessage=i("APPS.MESSAGES.TRIED_TO_CALL").format({number:Y(t.number)});else if(t.lastMessage==="")return}return u.useEffect(()=>{o?ee.set([...ee.value,t.id]):ee.set(ee.value.filter(l=>l!==t.id))},[o]),d(Z.div,{initial:{opacity:0,scale:.9},whileInView:{opacity:1,scale:1},viewport:{once:!0},className:"user",...f,onClick:()=>{n?a(!o):g()},children:[d("div",{className:"items",children:[n&&e(Z.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},className:"check","data-checked":o,onClick:l=>{l.stopPropagation(),a(!o)},children:o&&e(tt,{})},"check"),e("div",{className:ue("dot",t.unread&&"unread")})]}),t.isGroup?d("div",{className:"avatar group",children:[t.members.map((l,E)=>{var h;if(E<=3)return l.avatar?e("div",{"data-hasavatar":"true",style:{backgroundImage:`url(${l.avatar})`}},E):l.name?e("div",{children:(h=l==null?void 0:l.name)==null?void 0:h.charAt(0)},E):e("div",{className:"unknown"},E)}),t.members.length===0&&e("img",{className:"avatar",src:`assets/img/avatar-placeholder-${C.display.theme}.svg`})]}):e("div",{className:"avatar",style:{backgroundImage:t!=null&&t.avatar?`url(${t.avatar})`:null},children:t.name?!(t!=null&&t.avatar)&&se(t.name):e("img",{src:`assets/img/avatar-placeholder-${C.display.theme}.svg`,alt:""})}),d("div",{className:"user-body",children:[d("div",{className:"user-header",children:[e("div",{className:"name",children:T??Y(t.number)}),d("div",{className:"right",children:[e("div",{className:"time",children:at(t.timestamp)}),e(st,{})]})]}),e("div",{className:"content",children:((I=t.lastMessage)==null?void 0:I.length)>40?((s=t.lastMessage)==null?void 0:s.substring(0,40))+"...":t.lastMessage})]})]})};const ae=u.createContext(null);function kt(){const[t,n]=u.useState(null),[g,A]=u.useState("userlist"),[C,N]=u.useState(null),[o,a]=u.useState(0),[T,f]=u.useState(!1);return e("div",{className:"messages-container","data-view":g,children:e(ae.Provider,{value:{User:[t,n],View:[g,A],Newmessage:[T,f],ImportedUser:[C,N],UnreadMessages:[o,a]},children:g==="userlist"?e(wt,{}):t&&e(pt,{})})})}export{ae as MessagesContext,kt as default};
